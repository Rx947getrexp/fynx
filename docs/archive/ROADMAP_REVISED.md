# Fynx SSH - 修订后的开发路线图

**决策日期**: 2025-10-18
**决策**: 推迟 v0.1.0 发布，先补齐生产必需功能
**原因**: 功能对比分析显示缺少 4 个关键功能，当前版本无法实际使用

---

## 📋 决策背景

### 功能对比分析结果

对比 OpenSSH、russh、ssh2-rs 等成熟实现后，发现 fynx 缺少以下**生产环境必需功能**：

#### 🔴 Tier 1: 阻塞性缺失（无法实际使用）

1. **公钥认证 (publickey)** ❌
   - 最常用的认证方式（90%+ 的生产场景）
   - 自动化脚本必需
   - **影响**: 只能手动输密码，无法自动化

2. **known_hosts 支持** ❌
   - 防止中间人攻击
   - SSH 安全基础
   - **影响**: 当前接受任何主机密钥，极不安全

3. **authorized_keys 支持** ❌
   - 服务器端公钥认证
   - 多用户管理基础
   - **影响**: 服务器端基本不可用

4. **私钥文件加载** ❌
   - 加载 ~/.ssh/id_rsa 等密钥
   - 公钥认证的前提
   - **影响**: 公钥认证无法工作

#### ⚠️ Tier 2: 重要缺失（限制使用场景）

5. **SFTP 子系统** ❌ - 文件传输
6. **端口转发** ❌ - SSH 隧道
7. **keyboard-interactive** ❌ - 多因素认证
8. **Keepalive** ❌ - 长连接保活

### 对比其他 Rust SSH 库

| 功能 | russh | ssh2-rs | **fynx (当前)** | **fynx (目标)** |
|------|-------|---------|-----------------|-----------------|
| 公钥认证 | ✅ | ✅ | ❌ | ✅ v0.1.0 |
| known_hosts | ✅ | ⚠️ | ❌ | ✅ v0.1.0 |
| SFTP | ✅ | ✅ | ❌ | ✅ v0.2.0 |
| 端口转发 | ✅ | ✅ | ❌ | ✅ v0.2.0 |
| 纯 Rust | ✅ | ❌ C | ✅ | ✅ |
| 异步 | ✅ | ❌ | ✅ | ✅ |
| 代码质量 | ✅ | ⚠️ | ✅ | ✅ |

**结论**: fynx 架构优秀但功能不足，需补齐核心功能才能发布。

---

## 🎯 修订后的版本规划

### v0.0.1-alpha (当前) - 技术预览版

**状态**: ✅ 已完成（Phase 1）
**发布时间**: 2025-10-18
**用途**: 内部测试、技术预览、获取反馈

**包含功能**:
- ✅ 完整的协议栈（RFC 4251-4254）
- ✅ 密码认证
- ✅ 命令执行
- ✅ 现代密码学（Curve25519, ChaCha20-Poly1305, Ed25519）
- ✅ 175+ 测试全部通过

**明确限制**:
- ❌ **仅密码认证** - 无法自动化
- ❌ **无主机密钥验证** - 不安全
- ❌ **无文件传输** - 无 SFTP/SCP
- ⚠️ **不可用于生产环境**

**README 标注**:
```markdown
⚠️ **ALPHA VERSION - NOT FOR PRODUCTION USE**

This is a technical preview. Critical features are missing:
- No public key authentication
- No known_hosts verification (security risk!)
- No SFTP/file transfer
- For testing and feedback only
```

---

### v0.1.0 (目标) - 基本可用版 🎯

**目标发布**: 2025-12-15 (约 2 个月)
**里程碑**: 真正可用的 SSH 实现
**核心目标**: 补齐 4 个关键功能 + 基础安全

#### Stage 7: 公钥认证与密钥管理 (6 周)

**Week 1-2: 私钥加载与解析**
- [ ] PEM 格式私钥解析
  - RSA (PKCS#1, PKCS#8)
  - Ed25519
  - ECDSA (P-256, P-384, P-521)
- [ ] OpenSSH 私钥格式解析
  - "BEGIN OPENSSH PRIVATE KEY" 格式
  - bcrypt-pbkdf 密钥派生
- [ ] 加密私钥解密
  - AES-128-CBC, AES-256-CBC
  - AES-128-CTR, AES-256-CTR
- [ ] 私钥自动检测和加载
  - ~/.ssh/id_rsa, ~/.ssh/id_ed25519 等
- [ ] 密码提示输入（tty 交互）
- [ ] 私钥内存安全（zeroize）
- [ ] 单元测试 (15+)

**Week 3-4: 公钥认证实现**
- [ ] 客户端公钥认证
  - SSH_MSG_USERAUTH_REQUEST (publickey)
  - 签名生成（RSA, Ed25519, ECDSA）
  - try-then-sign 流程
- [ ] 服务器端公钥认证
  - 签名验证
  - authorized_keys 查找
- [ ] 公钥指纹计算
  - MD5 格式（legacy）
  - SHA256 格式（现代）
- [ ] 集成测试 (8+)
- [ ] OpenSSH 互操作测试

**Week 5: known_hosts 支持（客户端）**
- [ ] known_hosts 文件解析
  - 标准格式（hostname key）
  - 哈希格式（HMAC-SHA1）
  - 通配符模式
- [ ] 主机密钥验证逻辑
  - 精确匹配
  - 哈希匹配
  - 通配符匹配
- [ ] StrictHostKeyChecking 模式
  - yes: 拒绝未知主机
  - ask: 提示用户（终端交互）
  - accept-new: 自动添加新主机
  - no: 接受所有（不安全，仅测试）
- [ ] known_hosts 写入
  - 添加新主机
  - 更新已更改的主机密钥
- [ ] 主机密钥更改警告
- [ ] 单元测试 (12+)

**Week 6: authorized_keys 支持（服务器端）**
- [ ] authorized_keys 文件解析
  - 公钥格式（ssh-rsa, ssh-ed25519 等）
  - 注释处理
- [ ] 密钥选项支持
  - command="..." (强制命令)
  - no-port-forwarding
  - no-X11-forwarding
  - no-agent-forwarding
  - no-pty
  - from="pattern" (源 IP 限制)
  - environment="NAME=value"
- [ ] 密钥匹配算法
- [ ] 选项强制执行
- [ ] 单元测试 (10+)

**交付物**:
- ✅ 公钥认证（客户端和服务器）
- ✅ known_hosts 完整支持
- ✅ authorized_keys 完整支持
- ✅ 私钥文件加载（PEM + OpenSSH）
- ✅ 45+ 新测试

#### Stage 8: keyboard-interactive 认证 (1 周)

**Week 7: keyboard-interactive 实现**
- [ ] SSH_MSG_USERAUTH_INFO_REQUEST
- [ ] SSH_MSG_USERAUTH_INFO_RESPONSE
- [ ] 多轮交互支持
- [ ] 提示和回显控制
- [ ] PAM 集成框架（服务器端）
- [ ] OTP/2FA 支持框架
- [ ] 单元测试 (8+)

**交付物**:
- ✅ keyboard-interactive 认证
- ✅ 多因素认证框架
- ✅ 8+ 新测试

#### Stage 9: 安全增强与生产就绪 (1 周)

**Week 8: 安全加固**
- [ ] 认证速率限制
  - 每 IP 限制
  - 指数退避
  - 临时 IP 封禁
- [ ] 连接数限制
  - 全局最大连接数
  - 每用户连接数
  - 每 IP 连接数
- [ ] 会话超时
  - 认证超时
  - 空闲超时
  - 绝对超时
- [ ] 审计日志
  - 连接事件
  - 认证事件
  - 命令执行日志
  - 结构化日志（JSON）
- [ ] Banner 支持
  - 登录前横幅（/etc/issue.net）
  - 登录后横幅（/etc/motd）
- [ ] PermitRootLogin 控制
- [ ] AllowUsers/DenyUsers
- [ ] 单元测试 (15+)

**交付物**:
- ✅ 完整的安全控制
- ✅ 审计日志
- ✅ 生产级配置选项
- ✅ 15+ 新测试

#### v0.1.0 总结

**开发时间**: 8 周（2 个月）
**新增代码**: ~3,000 行
**新增测试**: 68+ 个
**总测试**: 243+ 个

**功能清单**:
- ✅ 密码认证（v0.0.1）
- ✅ **公钥认证**（新）
- ✅ **keyboard-interactive**（新）
- ✅ **known_hosts 验证**（新）
- ✅ **authorized_keys 支持**（新）
- ✅ 命令执行
- ✅ 交互式 Shell
- ✅ **安全控制**（速率限制、连接限制）
- ✅ **审计日志**

**可用场景**:
- ✅ 自动化脚本（公钥认证）
- ✅ 服务器管理（SSH 访问）
- ✅ 安全部署（known_hosts 验证）
- ✅ 企业环境（MFA、审计）
- ❌ 文件传输（需 v0.2.0 SFTP）
- ❌ 端口转发（需 v0.2.0）

**发布标准**:
- [ ] 所有新功能测试通过
- [ ] OpenSSH 互操作验证
- [ ] 外部安全审计
- [ ] 文档完整
- [ ] 性能基准测试
- [ ] 无已知安全漏洞

---

### v0.2.0 - 功能完整版

**目标发布**: 2026-02-15 (v0.1.0 后 2 个月)
**里程碑**: 功能完整的 SSH 实现
**核心目标**: 文件传输 + 端口转发

#### Stage 10: SFTP 子系统 (4 周)

- [ ] SFTP 协议实现（v3）
  - SSH_FXP_INIT/VERSION
  - SSH_FXP_OPEN/CLOSE/READ/WRITE
  - SSH_FXP_OPENDIR/READDIR
  - SSH_FXP_STAT/FSTAT/LSTAT
  - SSH_FXP_REMOVE/RENAME
  - SSH_FXP_MKDIR/RMDIR
  - SSH_FXP_SETSTAT/FSETSTAT
- [ ] 文件上传/下载
- [ ] 目录操作
- [ ] 权限管理
- [ ] 符号链接支持
- [ ] 大文件支持（分块传输）
- [ ] 进度回调
- [ ] 客户端 API
- [ ] 服务器端实现
- [ ] 集成测试 (20+)

#### Stage 11: SCP 协议 (1 周)

- [ ] SCP 协议解析
- [ ] 文件上传
- [ ] 文件下载
- [ ] 递归目录传输
- [ ] 权限保留
- [ ] 进度显示
- [ ] 集成测试 (10+)

#### Stage 12: 端口转发 (3 周)

- [ ] 本地端口转发 (-L)
  - direct-tcpip 通道
  - 本地监听器
  - 连接代理
- [ ] 远程端口转发 (-R)
  - tcpip-forward 全局请求
  - forwarded-tcpip 通道
  - 远程监听器
- [ ] 动态端口转发 (-D)
  - SOCKS4/5 协议
  - 动态通道创建
  - DNS 解析
- [ ] 端口转发管理
  - 列出活动转发
  - 取消转发
- [ ] authorized_keys 限制
- [ ] 集成测试 (15+)

#### Stage 13: Keepalive & 稳定性 (1 周)

- [ ] 客户端 Keepalive
- [ ] 服务器端 Keepalive
- [ ] SSH_MSG_GLOBAL_REQUEST
- [ ] 自动重连（客户端选项）
- [ ] 连接健康检查
- [ ] 集成测试 (8+)

#### v0.2.0 总结

**开发时间**: 9 周（2+ 个月）
**新增代码**: ~4,000 行
**新增测试**: 53+ 个
**总测试**: 296+ 个

**完整功能**:
- ✅ 所有认证方法
- ✅ 文件传输（SFTP + SCP）
- ✅ 端口转发（本地 + 远程 + 动态）
- ✅ Keepalive
- ✅ 完整的安全控制

---

### v0.3.0+ - 高级功能（Phase 3+）

**时间**: 2026 年中以后
**优先级**: 低（根据用户反馈调整）

#### 可选功能

- X11 转发
- Agent 转发
- SSH 证书认证
- Jump Host (ProxyJump)
- ControlMaster (连接共享)
- PKCS#11 支持
- Hardware Security Module (HSM)
- Kerberos/GSSAPI

---

## 📅 详细时间表

### 2025 Q4

| 周 | 日期 | 里程碑 | 交付物 |
|----|------|--------|--------|
| W43 | 10/21-10/27 | Stage 7.1 开始 | 私钥加载（PEM） |
| W44 | 10/28-11/03 | Stage 7.1 继续 | OpenSSH 私钥格式 |
| W45 | 11/04-11/10 | Stage 7.2 开始 | 公钥认证（客户端） |
| W46 | 11/11-11/17 | Stage 7.2 继续 | 公钥认证（服务器） |
| W47 | 11/18-11/24 | Stage 7.3 | known_hosts 支持 |
| W48 | 11/25-12/01 | Stage 7.4 | authorized_keys 支持 |
| W49 | 12/02-12/08 | Stage 8 | keyboard-interactive |
| W50 | 12/09-12/15 | Stage 9 | 安全增强 |
| W51 | 12/16-12/22 | **v0.1.0 发布** | 测试、文档、发布 |

### 2026 Q1

| 周 | 日期 | 里程碑 | 交付物 |
|----|------|--------|--------|
| W01 | 12/30-01/05 | 假期 | - |
| W02 | 01/06-01/12 | Stage 10.1 | SFTP 协议核心 |
| W03 | 01/13-01/19 | Stage 10.2 | SFTP 文件操作 |
| W04 | 01/20-01/26 | Stage 10.3 | SFTP 目录操作 |
| W05 | 01/27-02/02 | Stage 10.4 | SFTP 完善 |
| W06 | 02/03-02/09 | Stage 11 | SCP 协议 |
| W07 | 02/10-02/16 | Stage 12.1 | 本地端口转发 |
| W08 | 02/17-02/23 | Stage 12.2 | 远程端口转发 |
| W09 | 02/24-03/02 | Stage 12.3 | 动态端口转发 |
| W10 | 03/03-03/09 | Stage 13 | Keepalive |
| W11 | 03/10-03/16 | **v0.2.0 发布** | 测试、文档、发布 |

---

## 🎯 成功标准

### v0.1.0 发布条件（必须全部满足）

#### 功能完整性
- [x] Phase 1 所有功能
- [ ] 公钥认证（客户端和服务器）
- [ ] known_hosts 完整支持
- [ ] authorized_keys 完整支持
- [ ] keyboard-interactive 认证
- [ ] 安全控制（速率限制、连接限制）

#### 测试覆盖
- [ ] 单元测试 > 200 个
- [ ] 集成测试 > 20 个
- [ ] 所有测试通过率 100%
- [ ] OpenSSH 互操作验证（8.0+, 9.0+）

#### 安全性
- [ ] 外部安全审计通过
- [ ] 无已知严重漏洞
- [ ] cargo audit 清洁
- [ ] 模糊测试运行 (48h+)

#### 文档
- [ ] 完整 API 文档（rustdoc）
- [ ] 用户手册
- [ ] 安全最佳实践
- [ ] 迁移指南（从其他库）

#### 性能
- [ ] 认证延迟 < 100ms
- [ ] 吞吐量 > 100MB/s (localhost)
- [ ] 内存使用 < 10MB/连接

### v0.2.0 发布条件

- [ ] v0.1.0 所有条件
- [ ] SFTP 子系统完整
- [ ] 端口转发完整
- [ ] 与 FileZilla/WinSCP 互操作
- [ ] 性能基准测试通过

---

## 🔄 风险与应对

### 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 私钥格式兼容性问题 | 高 | 中 | 参考 russh 实现，广泛测试 |
| OpenSSH 互操作失败 | 高 | 低 | 早期测试，持续验证 |
| 性能不达标 | 中 | 低 | 早期基准测试，优化 |
| 安全漏洞 | 高 | 中 | 外部审计，模糊测试 |

### 进度风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 功能低估 | 中 | 中 | 20% 缓冲时间 |
| 测试时间不足 | 高 | 中 | 并行测试，自动化 |
| 文档滞后 | 低 | 高 | 边开发边写文档 |

---

## 📊 资源需求

### 开发时间

- **v0.1.0**: 8 周全职（或 16 周兼职）
- **v0.2.0**: 9 周全职（或 18 周兼职）
- **总计**: ~4-5 个月

### 外部依赖

- **安全审计**: 外包给安全公司（$5k-10k）
- **性能基准**: 云服务器资源
- **CI/CD**: GitHub Actions（免费）

---

## 🎊 版本对比

| 特性 | v0.0.1-alpha | v0.1.0 | v0.2.0 |
|------|--------------|--------|--------|
| **状态** | ✅ 完成 | 🎯 目标 | 🔮 计划 |
| 发布时间 | 2025-10 | 2025-12 | 2026-03 |
| | | | |
| **认证** | | | |
| 密码 | ✅ | ✅ | ✅ |
| 公钥 | ❌ | ✅ | ✅ |
| keyboard-interactive | ❌ | ✅ | ✅ |
| | | | |
| **安全** | | | |
| known_hosts | ❌ | ✅ | ✅ |
| authorized_keys | ❌ | ✅ | ✅ |
| 速率限制 | ❌ | ✅ | ✅ |
| 审计日志 | ❌ | ✅ | ✅ |
| | | | |
| **文件传输** | | | |
| SFTP | ❌ | ❌ | ✅ |
| SCP | ❌ | ❌ | ✅ |
| | | | |
| **网络** | | | |
| 命令执行 | ✅ | ✅ | ✅ |
| 本地转发 | ❌ | ❌ | ✅ |
| 远程转发 | ❌ | ❌ | ✅ |
| 动态转发 | ❌ | ❌ | ✅ |
| Keepalive | ❌ | ❌ | ✅ |
| | | | |
| **用途** | | | |
| 生产使用 | ❌ | ✅ | ✅ |
| 自动化 | ❌ | ✅ | ✅ |
| 文件传输 | ❌ | ❌ | ✅ |
| 端口转发 | ❌ | ❌ | ✅ |

---

## 📣 沟通计划

### v0.0.1-alpha 公告

**标题**: "Fynx SSH v0.0.1-alpha - 技术预览版"

**内容**:
```markdown
我们发布了 fynx SSH 的技术预览版 (v0.0.1-alpha)！

✅ 已完成：
- 完整的 SSH 协议栈（RFC 4251-4254）
- 密码认证
- 命令执行
- 现代密码学（Curve25519, ChaCha20-Poly1305, Ed25519）
- 175+ 测试，100% 通过

⚠️ 限制：
- 仅密码认证（无公钥认证）
- 无主机密钥验证（不安全）
- 无文件传输
- 不可用于生产

🎯 v0.1.0 计划（2025-12）：
- 公钥认证
- known_hosts 支持
- authorized_keys 支持
- 安全增强
- 生产就绪

欢迎反馈！
```

### v0.1.0 公告

**标题**: "Fynx SSH v0.1.0 - 生产就绪版"

**内容**:
```markdown
经过 2 个月的开发，我们发布了 fynx SSH v0.1.0！

这是第一个可用于生产环境的版本。

🎉 新功能：
- ✅ 公钥认证（RSA, Ed25519, ECDSA）
- ✅ known_hosts 验证（防中间人攻击）
- ✅ authorized_keys 支持
- ✅ keyboard-interactive（MFA 支持）
- ✅ 安全控制（速率限制、连接限制）
- ✅ 审计日志

📊 质量：
- 243+ 测试全部通过
- 外部安全审计通过
- OpenSSH 8.0+, 9.0+ 互操作验证
- 零 unsafe 代码

🚀 可用场景：
- 自动化脚本
- 服务器管理
- 企业部署（MFA、审计）

📅 下一步（v0.2.0, 2026-03）：
- SFTP 文件传输
- 端口转发
- Keepalive
```

---

**路线图版本**: 2.0
**创建日期**: 2025-10-18
**决策者**: Project Lead
**批准日期**: 2025-10-18
**下次审查**: v0.1.0 发布后
